# Тестирование Course Index Generator

Документация по тестам для сервиса генерации course index.

## Обзор

`CourseIndexGenerator` — сервис для генерации `slides.json` из обнаруженных лекций курса.

## Функциональность

- **Генерация slides.json**: Создание файла индекса курса из лекций
- **Сортировка лекций**: Детерминированный порядок по дате и ID
- **Структурирование данных**: Формирование записей с метаданными лекций
- **Совместимость форматов**: Поддержка старого и нового форматов slides.json

## Форматы slides.json

### Новый формат (запись)
```json
{
  "title": "Название курса",
  "lectures": [
    {
      "id": "lecture-id",
      "title": "Название лекции",
      "description": "Описание (опционально)",
      "date": "2024-01-15 (опционально)",
      "url": "/course/lecture-id"
    }
  ]
}
```

### Старый формат (чтение)
```json
{
  "slides": [
    {
      "name": "lecture-id",
      "title": "Название лекции"
    }
  ]
}
```

## Тесты

### generate()

| Тест | Описание |
|------|----------|
| Генерация slides.json с корректной структурой | Проверяет создание файла с правильной структурой |
| Запись файла в выходную директорию | Проверяет создание файла по указанному пути |
| Обработка нескольких лекций | Проверяет обработку массива лекций |
| Пропуск невалидных лекций | Проверяет фильтрацию только валидных лекций |
| Пропуск лекций без slides.md | Проверяет пропуск директорий без файла |

### Детерминированный порядок

| Тест | Описание |
|------|----------|
| Сортировка по дате | Проверяет сортировку по полю date |
| Сортировка по ID | Проверяет fallback сортировку по ID для лекций без даты |
| Приоритет даты | Проверяет, что лекции с датой идут раньше |
| Повторяемость | Проверяет одинаковый порядок при повторных запусках |

### Формат записей

| Тест | Описание |
|------|----------|
| Обязательные поля | Проверяет наличие полей id, title, url |
| URL лекции | Проверяет корректность формирования URL с baseUrl |
| Опциональные поля | Проверяет обработку description и date |

### needsRegeneration()

| Тест | Описание |
|------|----------|
| Файл не существует | Проверяет возврат true при отсутствии slides.json |
| Лекции не изменялись | Проверяет возврат false при актуальном индексе |
| Изменение slides.md | Проверяет возврат true при модификации лекции |

### Поддержка старого формата

| Тест | Описание |
|------|----------|
| Чтение старого формата | Проверяет парсинг `{ slides: [{ name, title }] }` |
| Формирование URL | Проверяет генерацию URL для лекций из старого формата |
| isLegacyFormat() | Проверяет определение старого формата |
| convertToCourseIndex() | Проверяет конвертацию старого формата в новый |
| getLectures() | Проверяет получение лекций из старого формата |
| getSlidesJsonInfo() | Проверяет определение формата файла |

## Запуск тестов

```bash
pnpm run test:unit
```

## Зависимости

- `LectureDiscoveryService` — обнаружение лекций
- `gray-matter` — парсинг frontmatter
- `fs-extra` — файловые операции